# –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã Lab_12

## üéØ –û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

–≠—Ç–∞ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å **COM (Component Object Model)** - —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–µ–π Microsoft –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤. COM –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑ —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:**
```
SP02_COM (COM DLL) 
    ‚Üì
SP12_LIB (–æ–±–µ—Ä—Ç–∫–∞-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞)
    ‚Üì
SP12_02 –∏ SP12_04 (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
```

---

## üì¶ –ü—Ä–æ–µ–∫—Ç 1: SP02_COM (COM –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)

–≠—Ç–æ **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (DLL)**, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–∞–ª–∏–∑—É–µ—Ç COM-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏.

### –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞:

#### **1. IAdder.h** - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–ª–æ–∂–µ–Ω–∏—è/–≤—ã—á–∏—Ç–∞–Ω–∏—è
```cpp
__interface IAdder : IUnknown {
    virtual HRESULT __stdcall Add(const double, const double, double&) = 0;
    virtual HRESULT __stdcall Sub(const double, const double, double&) = 0;
};
```
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–∫–æ–Ω—Ç—Ä–∞–∫—Ç) –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å–ª–æ–∂–µ–Ω–∏—è –∏ –≤—ã—á–∏—Ç–∞–Ω–∏—è
- **IUnknown:** –ë–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å COM (QueryInterface, AddRef, Release)
- **HRESULT:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–∏–ø –≤–æ–∑–≤—Ä–∞—Ç–∞ COM (–∫–æ–¥ —É—Å–ø–µ—Ö–∞/–æ—à–∏–±–∫–∏)

#### **2. IMultiplier.h** - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–º–Ω–æ–∂–µ–Ω–∏—è/–¥–µ–ª–µ–Ω–∏—è
```cpp
__interface IMultiplier : IUnknown {
    virtual HRESULT __stdcall Mul(const double, const double, double&) = 0;
    virtual HRESULT __stdcall Div(const double, const double, double&) = 0;
};
```
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —É–º–Ω–æ–∂–µ–Ω–∏—è –∏ –¥–µ–ª–µ–Ω–∏—è

#### **3. SP02.h** - –ö–ª–∞—Å—Å, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π –æ–±–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
```cpp
class SP02 : public IAdder, public IMultiplier {
    ULONG counter;  // —Å—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫
    // –ú–µ—Ç–æ–¥—ã IUnknown
    QueryInterface, AddRef, Release
    // –ú–µ—Ç–æ–¥—ã IAdder
    Add, Sub
    // –ú–µ—Ç–æ–¥—ã IMultiplier
    Mul, Div
};
```
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ:** –ö–ª–∞—Å—Å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –æ–±–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **counter:** –°—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –æ–±—ä–µ–∫—Ç–∞ (COM)

#### **4. SP02.cpp** - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Å–∞ SP02

**QueryInterface** - –ø–æ–ª—É—á–µ–Ω–∏–µ —É–∫–∞–∑–∞—Ç–µ–ª—è –Ω–∞ –Ω—É–∂–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
```cpp
if (iid == IID_IUnknown || iid == IID_IAdder) {
    *ppv = static_cast<IAdder*>(this);
}
else if (iid == IID_IMultiplier) {
    *ppv = static_cast<IMultiplier*>(this);
}
```

**AddRef/Release** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–º —Å—Å—ã–ª–æ–∫:
- `AddRef()` - —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ (–æ–±—ä–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- `Release()` - —É–º–µ–Ω—å—à–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ (–æ–±—ä–µ–∫—Ç –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω)
- –ö–æ–≥–¥–∞ —Å—á–µ—Ç—á–∏–∫ = 0, –æ–±—ä–µ–∫—Ç —É–¥–∞–ª—è–µ—Ç—Å—è

**–ú–µ—Ç–æ–¥—ã –æ–ø–µ—Ä–∞—Ü–∏–π:**
- `Add(x, y, c)` ‚Üí `c = x + y`
- `Sub(x, y, c)` ‚Üí `c = x - y`
- `Mul(x, y, c)` ‚Üí `c = x * y`
- `Div(x, y, c)` ‚Üí `c = x / y` (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–µ–ª–µ–Ω–∏—è –Ω–∞ 0)

#### **5. MathFactory.h/cpp** - –§–∞–±—Ä–∏–∫–∞ –∫–ª–∞—Å—Å–æ–≤

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–ª–∞—Å—Å–∞ SP02 –ø–æ –∑–∞–ø—Ä–æ—Å—É COM

**CreateInstance** - —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞:
```cpp
SP02* pSP = new SP02();
hr = pSP->QueryInterface(riid, ppvObj);
```

**LockServer** - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏ DLL)

#### **6. Guids.cpp** - –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (GUID)

```cpp
DEFINE_GUID(CLSID_SP02, ...);      // ID –∫–ª–∞—Å—Å–∞ SP02
DEFINE_GUID(IID_IAdder, ...);      // ID –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ IAdder
DEFINE_GUID(IID_IMultiplier, ...); // ID –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ IMultiplier
```

- **GUID** - 128-–±–∏—Ç–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- **CLSID** - –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∫–ª–∞—Å—Å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞)
- **IID** - –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞)

#### **7. Registry.h/cpp** - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Ä–µ–µ—Å—Ç—Ä–µ Windows

**RegisterServer** - —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç COM –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ —Ä–µ–µ—Å—Ç—Ä–µ:
- –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ `HKEY_CLASSES_ROOT\CLSID\{...}`
- –£–∫–∞–∑—ã–≤–∞–µ—Ç –ø—É—Ç—å –∫ DLL
- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç ProgID (—á–∏—Ç–∞–µ–º–æ–µ –∏–º—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞)

**UnregisterServer** - —É–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞

**–ó–∞—á–µ–º:** Windows –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–µ—Å—Ç—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ COM –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø–æ CLSID

#### **8. dllmain.cpp** - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ DLL

**DllMain** - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ/–≤—ã–≥—Ä—É–∑–∫–µ DLL:
```cpp
case DLL_PROCESS_ATTACH:
    hmodule = hModule;  // –°–æ—Ö—Ä–∞–Ω—è–µ–º handle –º–æ–¥—É–ª—è
```

**DllGetClassObject** - **–ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø COM:**
```cpp
// –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç CoCreateInstance(CLSID_SP02, ...),
// Windows –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é
MathFactory* pF = new MathFactory();
rc = pF->QueryInterface(iid, ppv);
```

**DllRegisterServer/DllUnregisterServer** - –≤—ã–∑—ã–≤–∞—é—Ç—Å—è `regsvr32.exe` –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**DllCanUnloadNow** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –≤—ã–≥—Ä—É–∑–∏—Ç—å DLL (–∫–æ–≥–¥–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤)

#### **9. SP02_COM.def** - –§–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–π

–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑–≤–Ω–µ DLL:
- `DllGetClassObject` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–±—Ä–∏–∫–∏
- `DllCanUnloadNow` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–≥—Ä—É–∑–∫–∏
- `DllRegisterServer` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- `DllUnregisterServer` - –æ—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

---

## üìö –ü—Ä–æ–µ–∫—Ç 2: SP12_LIB (–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞-–æ–±–µ—Ä—Ç–∫–∞)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å COM –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º, —Å–∫—Ä—ã–≤–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å COM API.

### –§–∞–π–ª—ã:

#### **1. SP12_LIB.h** - –ü—É–±–ª–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

```cpp
namespace OS12 {
    OS12HANDEL Init();  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è COM –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
    
    namespace Adder {
        double Add(OS12HANDEL h, double x, double y);
        double Sub(OS12HANDEL h, double x, double y);
    }
    
    namespace Multiplier {
        double Mul(OS12HANDEL h, double x, double y);
        double Div(OS12HANDEL h, double x, double y);
    }
    
    void Dispose(OS12HANDEL h);  // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–æ—Å—Ç–æ–π C++ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–≥–æ COM API
- –ù–µ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –ø—Ä–æ IUnknown, QueryInterface, HRESULT
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ã—á–Ω—ã–µ `double` –≤–º–µ—Å—Ç–æ HRESULT

#### **2. SP12_LIB.cpp** - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–µ—Ä—Ç–∫–∏

**OS12Context** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è COM –æ–±—ä–µ–∫—Ç–∞:
```cpp
struct OS12Context {
    IUnknown* pIUnknown;  // –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ COM –æ–±—ä–µ–∫—Ç
};
```

**Init()** - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
```cpp
CoInitialize(NULL);  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è COM –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
CoCreateInstance(CLSID_SP02, ..., IID_IUnknown, ...);  // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
```

**Add/Sub/Mul/Div** - –æ–±–µ—Ä—Ç–∫–∏ –Ω–∞–¥ COM –º–µ—Ç–æ–¥–∞–º–∏:
```cpp
// 1. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–∑ –æ–±—ä–µ–∫—Ç–∞
ctx->pIUnknown->QueryInterface(IID_IAdder, (void**)&pIAdder);

// 2. –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥
pIAdder->Add(x, y, result);

// 3. –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
pIAdder->Release();
```

**Dispose()** - –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ:
```cpp
ctx->pIUnknown->Release();  // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º COM –æ–±—ä–µ–∫—Ç
CoUninitialize();            // –î–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è COM
```

---

## üñ•Ô∏è –ü—Ä–æ–µ–∫—Ç 3: SP12_02 (–ö–ª–∏–µ–Ω—Ç —Å –ø—Ä—è–º—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º COM)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å COM –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º **–Ω–∞–ø—Ä—è–º—É—é**, –±–µ–∑ –æ–±–µ—Ä—Ç–∫–∏.

### SP12_02.cpp - –ü—Ä—è–º–∞—è —Ä–∞–±–æ—Ç–∞ —Å COM

**–®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è COM**
```cpp
CoInitialize(NULL);  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ OLE32
```

**–®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ COM –æ–±—ä–µ–∫—Ç–∞**
```cpp
CoCreateInstance(
    CLSID_SP02,              // –ö–∞–∫–æ–π –∫–ª–∞—Å—Å —Å–æ–∑–¥–∞—Ç—å
    NULL,                    // –ê–≥—Ä–µ–≥–∞—Ü–∏—è (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
    CLSCTX_INPROC_SERVER,    // –í–Ω—É—Ç—Ä–∏–ø—Ä–æ—Ü–µ—Å—Å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (DLL)
    IID_IUnknown,            // –ö–∞–∫–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª—É—á–∏—Ç—å
    (void**)&pIUnknown       // –ö—É–¥–∞ –∑–∞–ø–∏—Å–∞—Ç—å —É–∫–∞–∑–∞—Ç–µ–ª—å
);
```

**–®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ IAdder**
```cpp
pIUnknown->QueryInterface(IID_IAdder, (void**)&pIAdder);
```

**–®–∞–≥ 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞**
```cpp
pIAdder->Add(2.0, 3.0, z);  // z = 5.0
pIAdder->Sub(2.0, 3.0, z);  // z = -1.0
```

**–®–∞–≥ 5: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥—Ä—É–≥–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–∑ —Ç–æ–≥–æ –∂–µ –æ–±—ä–µ–∫—Ç–∞**
```cpp
// QueryInterface –º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –Ω–∞ –ª—é–±–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
pIAdder->QueryInterface(IID_IMultiplier, (void**)&pMultiplier);
pMultiplier->Mul(2.0, 3.0, z);  // z = 6.0
```

**–®–∞–≥ 6: –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤**
```cpp
pIAdder->Release();
pMultiplier->Release();
pIUnknown->Release();
CoUninitialize();
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ù—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —É–ø—Ä–∞–≤–ª—è—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏
- –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å HRESULT –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç COM "–ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º"

---

## üñ•Ô∏è –ü—Ä–æ–µ–∫—Ç 4: SP12_04 (–ö–ª–∏–µ–Ω—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç **—É–ø—Ä–æ—â–µ–Ω–Ω—É—é** —Ä–∞–±–æ—Ç—É —Å COM —á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É SP12_LIB.

### SP12_04.cpp - –†–∞–±–æ—Ç–∞ —á–µ—Ä–µ–∑ –æ–±–µ—Ä—Ç–∫—É

**–®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**
```cpp
OS12HANDEL h1 = OS12::Init();  // –°–æ–∑–¥–∞–µ—Ç COM –æ–±—ä–µ–∫—Ç –≤–Ω—É—Ç—Ä–∏
OS12HANDEL h2 = OS12::Init();  // –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
```

**–®–∞–≥ 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**
```cpp
// –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ - –Ω–∏–∫–∞–∫–æ–≥–æ COM API!
OS12::Adder::Add(h1, 2, 3);        // = 5
OS12::Adder::Sub(h1, 2, 3);        // = -1
OS12::Multiplier::Mul(h1, 2, 3);   // = 6
OS12::Multiplier::Div(h1, 2, 3);   // = 0.666...
```

**–®–∞–≥ 3: –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ**
```cpp
OS12::Dispose(h1);
OS12::Dispose(h2);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∫–æ–¥
- –ù–µ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –ø—Ä–æ COM
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

---

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª COM –æ–±—ä–µ–∫—Ç–∞

```
1. CoInitialize()           ‚Üí –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è COM
2. CoCreateInstance()      ‚Üí Windows –Ω–∞—Ö–æ–¥–∏—Ç DLL –ø–æ CLSID –≤ —Ä–µ–µ—Å—Ç—Ä–µ
                          ‚Üí –ó–∞–≥—Ä—É–∂–∞–µ—Ç DLL
                          ‚Üí –í—ã–∑—ã–≤–∞–µ—Ç DllGetClassObject()
                          ‚Üí –°–æ–∑–¥–∞–µ—Ç MathFactory
                          ‚Üí MathFactory —Å–æ–∑–¥–∞–µ—Ç SP02
                          ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ IUnknown
3. QueryInterface()        ‚Üí –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω—É–∂–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (IAdder/IMultiplier)
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤   ‚Üí Add, Sub, Mul, Div
5. Release()               ‚Üí –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å—Å—ã–ª–æ–∫
6. CoUninitialize()        ‚Üí –î–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è COM
```

---

## üéì –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ COM

### 1. **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (Interfaces)**
- –ö–æ–Ω—Ç—Ä–∞–∫—Ç –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —Å–µ—Ä–≤–µ—Ä–æ–º
- –í—Å–µ –º–µ—Ç–æ–¥—ã –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ (pure virtual)
- –ù–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç IUnknown

### 2. **IUnknown**
- –ë–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—Å–µ—Ö COM –æ–±—ä–µ–∫—Ç–æ–≤
- **QueryInterface** - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥—Ä—É–≥–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- **AddRef** - —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å—Å—ã–ª–æ–∫
- **Release** - —É–º–µ–Ω—å—à–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å—Å—ã–ª–æ–∫

### 3. **GUID (Globally Unique Identifier)**
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π 128-–±–∏—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- **CLSID** - –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∫–ª–∞—Å—Å
- **IID** - –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### 4. **–°—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ (Reference Counting)**
- –ö–∞–∂–¥—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–º–µ–µ—Ç —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ö–æ–≥–¥–∞ —Å—á–µ—Ç—á–∏–∫ = 0, –æ–±—ä–µ–∫—Ç —É–¥–∞–ª—è–µ—Ç—Å—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

### 5. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Ä–µ–µ—Å—Ç—Ä–µ**
- Windows –∏—â–µ—Ç COM –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ CLSID –≤ —Ä–µ–µ—Å—Ç—Ä–µ
- `regsvr32.exe` –≤—ã–∑—ã–≤–∞–µ—Ç DllRegisterServer()
- –°–æ–∑–¥–∞—é—Ç—Å—è –∑–∞–ø–∏—Å–∏ —Å –ø—É—Ç–µ–º –∫ DLL

### 6. **–§–∞–±—Ä–∏–∫–∞ –∫–ª–∞—Å—Å–æ–≤ (Class Factory)**
- –°–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä—ã COM –æ–±—ä–µ–∫—Ç–æ–≤
- –†–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å IClassFactory
- DllGetClassObject –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∞–±—Ä–∏–∫—É

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ê—Å–ø–µ–∫—Ç | SP12_02 (–ø—Ä—è–º–æ–π COM) | SP12_04 (—á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É) |
|--------|---------------------|---------------------------|
| –°–ª–æ–∂–Ω–æ—Å—Ç—å | –í—ã—Å–æ–∫–∞—è | –ù–∏–∑–∫–∞—è |
| –ö–æ–Ω—Ç—Ä–æ–ª—å | –ü–æ–ª–Ω—ã–π | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π |
| –ö–æ–¥ | –ú–Ω–æ–≥–æ—Å–ª–æ–≤–Ω—ã–π | –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π |
| –û—à–∏–±–∫–∏ | HRESULT –≤—Ä—É—á–Ω—É—é | –ò—Å–∫–ª—é—á–µ–Ω–∏—è |
| –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è | –ò–∑—É—á–µ–Ω–∏—è COM | –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ |

---

## üéØ –ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞

1. **–°–æ–∑–¥–∞–Ω–∏–µ COM –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞** - –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å DLL —Å COM –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏
2. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞** - –∫–∞–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ COM –Ω–∞–ø—Ä—è–º—É—é** - –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Ä–∞–±–æ—Ç–∞ —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏
4. **–°–æ–∑–¥–∞–Ω–∏–µ –æ–±–µ—Ä—Ç–∫–∏** - —É–ø—Ä–æ—â–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å COM
5. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã** - –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç, –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
6. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º** - —Å—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫, –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

---

## üí° –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã

- **COM** - –º–æ—â–Ω–∞—è, –Ω–æ —Å–ª–æ–∂–Ω–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è
- **–û–±–µ—Ä—Ç–∫–∏** —É–ø—Ä–æ—â–∞—é—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ COM –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö
- **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è** –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã COM –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **–°—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫** - –æ—Å–Ω–æ–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é –≤ COM
- **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã** –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –≥–∏–±–∫–æ—Å—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å

